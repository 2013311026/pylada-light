

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>nrelmat.ScanOutcar &mdash; Pylada 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="top" title="Pylada 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pylada 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for nrelmat.ScanOutcar</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span> <span class="nb">all</span><span class="o">=</span><span class="s">&#39;raise&#39;</span><span class="p">,</span> <span class="n">under</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">readVasp</span>
<span class="kn">import</span> <span class="nn">wrapUpload</span>

<span class="c">#====================================================================</span>

<span class="k">def</span> <span class="nf">badparms</span><span class="p">(</span>
  <span class="n">msg</span><span class="p">):</span>           <span class="c"># error message</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Displays an error message and quits.</span>

<span class="sd">Command line parameters for the test driver:</span>

<span class="sd">==============  =========    ==============================================</span>
<span class="sd">Parameter       Type         Description</span>
<span class="sd">==============  =========    ==============================================</span>
<span class="sd">-bugLev         integer      Debug level.  Normally 0.</span>
<span class="sd">-inDir          string       Input dir containing OUTCAR, INCAR, POSCAR</span>
<span class="sd">==============  =========    ==============================================</span>
<span class="sd">&#39;&#39;&#39;</span>

  <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Error: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>
  <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">badparms</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c">#====================================================================</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Test driver.</span>
<span class="sd">Extracts info from VASP OUTCAR, INCAR, and POSCAR files.</span>
<span class="sd">See doc for badparms.</span>
<span class="sd">&#39;&#39;&#39;</span>

  <span class="n">bugLev</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">inDir</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">badparms</span><span class="p">(</span><span class="s">&#39;Parms must be key/value pairs&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">iarg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">iarg</span><span class="p">]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="n">iarg</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;-bugLev&#39;</span><span class="p">:</span> <span class="n">bugLev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;-inDir&#39;</span><span class="p">:</span> <span class="n">inDir</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">badparms</span><span class="p">(</span><span class="s">&#39;unknown key: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>

  <span class="k">if</span> <span class="n">bugLev</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">badparms</span><span class="p">(</span><span class="s">&#39;parm not specified: -bugLev&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">inDir</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">badparms</span><span class="p">(</span><span class="s">&#39;parm not specified: -inDir&#39;</span><span class="p">)</span>

  <span class="n">resObj</span> <span class="o">=</span> <span class="n">ResClass</span><span class="p">()</span>
  <span class="n">scannerUnused</span> <span class="o">=</span> <span class="n">ScanOutcar</span><span class="p">(</span> <span class="n">bugLev</span><span class="p">,</span> <span class="n">inDir</span><span class="p">,</span> <span class="n">resObj</span><span class="p">)</span>


<span class="c">#====================================================================</span>
<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="ResClass"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ResClass">[docs]</a><span class="k">class</span> <span class="nc">ResClass</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  A container for the results of scanOutcar.</span>
<span class="sd">  The results are saved as attributes of the object.</span>
<span class="sd">  &#39;&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">):</span>          <span class="c"># self</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Formats self.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
      <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
      <span class="n">stg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">val</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">stg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">sep</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">sep</span> <span class="o">=</span> <span class="s">&#39; &#39;</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;  </span><span class="si">%s</span><span class="s">:  type: </span><span class="si">%s</span><span class="s">  val:</span><span class="si">%s%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">sep</span><span class="p">,</span> <span class="n">val</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">msg</span>

<span class="c">#====================================================================</span>
<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="Sspec"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.Sspec">[docs]</a><span class="k">class</span> <span class="nc">Sspec</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Specifies regex, numMin, etc, for one scalar to be found in OUTCAR.</span>
<span class="sd">  &#39;&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>       <span class="c"># self</span>
    <span class="n">tag</span><span class="p">,</span>        <span class="c"># resObj attribute name to set</span>
    <span class="n">pat</span><span class="p">,</span>        <span class="c"># regex to match in OUTCAR</span>
    <span class="n">which</span><span class="p">,</span>      <span class="c"># &#39;first&#39; or &#39;last&#39;: which match to use</span>
    <span class="n">numMin</span><span class="p">,</span>     <span class="c"># min number of matches</span>
    <span class="n">numMax</span><span class="p">,</span>     <span class="c"># max number of matches, or 0 for any number</span>
    <span class="n">tp</span><span class="p">):</span>        <span class="c"># result type: int, float, or str</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Saves the parameters.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">pat</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">which</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">numMin</span> <span class="o">=</span> <span class="n">numMin</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">numMax</span> <span class="o">=</span> <span class="n">numMax</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">)):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;invalid spec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">which</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;last&#39;</span><span class="p">]:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;invalid spec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;invalid spec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="n">pat</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">):</span>           <span class="c"># self</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Formats self.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s">&#39;tag: </span><span class="si">%s</span><span class="s">  pat: </span><span class="si">%s</span><span class="s">  which: </span><span class="si">%s</span><span class="s">  numMin: </span><span class="si">%d</span><span class="s">  numMax: </span><span class="si">%d</span><span class="s">  tp: </span><span class="si">%s</span><span class="s">&#39;</span> \
      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">which</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numMin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numMax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">res</span>

  <span class="k">def</span> <span class="nf">throwerr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>                <span class="c"># self</span>
    <span class="n">msg</span><span class="p">):</span>                <span class="c"># error message</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Raises an Exception.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="n">msg</span><span class="p">)</span>

<span class="c">#====================================================================</span>
<span class="c">#====================================================================</span>


<span class="c"># Fills resObj.</span>
</div>
<div class="viewcode-block" id="ScanOutcar"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar">[docs]</a><span class="k">class</span> <span class="nc">ScanOutcar</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Extracts info from OUTCAR, INCAR, and POSCAR files.</span>
<span class="sd">  Typical usage::</span>

<span class="sd">    resObj = ResClass()</span>
<span class="sd">    ScanOutcar( bugLev, inDir, resObj)</span>
<span class="sd">    print &#39;ediff: %g&#39; % (resObj.ediff,)</span>
<span class="sd">  &#39;&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">bugLev</span><span class="p">,</span>          <span class="c"># debug level</span>
    <span class="n">inDir</span><span class="p">,</span>           <span class="c"># input directory</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sets variables.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">=</span> <span class="n">bugLev</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inDir</span> <span class="o">=</span> <span class="n">inDir</span>

    <span class="k">if</span> <span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;ScanOutcar: inDir: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inDir</span><span class="p">,)</span>

    <span class="c"># First, read POSCAR and INCAR</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">inDir</span><span class="p">,</span> <span class="s">&#39;INCAR&#39;</span><span class="p">)):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parseIncar</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>

    <span class="c"># We no longer use the POSCAR file since everything</span>
    <span class="c"># in it can be derived from the OUTCAR file.</span>
    <span class="c">#if os.path.exists( os.path.join( self.inDir, &#39;POSCAR&#39;)):</span>
    <span class="c">#  self.parsePoscar( resObj)</span>

    <span class="c"># Now read OUTCAR</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">inDir</span><span class="p">,</span> <span class="s">&#39;OUTCAR&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">numLine</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
    <span class="c"># Strip all lines</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">numLine</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">getScalars</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">getDate</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getTimes</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getSystem</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getCategEnergy</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getBasisMats</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">getTypeNames</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getTypeNums</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getTypeMassValence</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getTypePseudos</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>

    <span class="n">numType</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getLdau</span><span class="p">(</span> <span class="n">numType</span><span class="p">,</span> <span class="n">resObj</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">unsorted atomTypes:&#39;</span>
      <span class="k">print</span> <span class="s">&#39;numType: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">numType</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;typeNames: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;typeNums: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;typeMasses_amu: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeMasses_amu</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;typeValences: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeValences</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;typePseudos: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typePseudos</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;numAtom: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span><span class="p">,)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numType</span> \
      <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeMasses_amu</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numType</span> \
      <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeValences</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numType</span> \
      <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typePseudos</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numType</span><span class="p">:</span>
      <span class="n">errMsg</span> <span class="o">=</span> <span class="s">&#39;types mismatch.  fname: </span><span class="si">%s</span><span class="se">\n</span><span class="s">  typeNames: </span><span class="si">%s</span><span class="se">\n</span><span class="s">  typeNums: </span><span class="si">%s</span><span class="se">\n</span><span class="s">  typeMasses_amu: </span><span class="si">%s</span><span class="se">\n</span><span class="s">  typeValences: </span><span class="si">%s</span><span class="se">\n</span><span class="s">  typePseudos: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span> <span class="n">fname</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeMasses_amu</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeValences</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typePseudos</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">errMsg</span><span class="p">,)</span>
      <span class="c"># self.throwerr( errMsg, None)</span>

    <span class="c">## Sort parallel arrays typeNames, typeNums, etc,</span>
    <span class="c">## by typeNames alphabetic order.</span>
    <span class="c">## Use an index sort with typeIxs.</span>
    <span class="c">## In rare cases like icsd_024360.cif/hs-ferro</span>
    <span class="c">## and icsd_060845_GW, the names are out of order.</span>
    <span class="c">## Sort to set typeIxs[newIx] == oldIx.</span>
    <span class="c">#ntype = len( resObj.typeNames)</span>
    <span class="c">#typeIxs = range( ntype)</span>
    <span class="c">#def sortFunc(</span>
    <span class="c">#  ia,    # resObj A</span>
    <span class="c">#  ib):   # resObj B</span>
    <span class="c">#  &#39;&#39;&#39;</span>
    <span class="c">#  Sort function for sorting resObj.typeNames</span>
    <span class="c">#  &#39;&#39;&#39;</span>
    <span class="c">#  return cmp( resObj.typeNames[ia], resObj.typeNames[ib])</span>
    <span class="c">#typeIxs.sort( sortFunc)</span>
    <span class="c">#if bugLev &gt;= 5:</span>
    <span class="c">#  print &#39;typeIxs: %s&#39; % (typeIxs,)</span>

    <span class="c">#resObj.typeIxs        = typeIxs</span>
    <span class="c">#resObj.typeNames      = [resObj.typeNames[ix] for ix in typeIxs]</span>
    <span class="c">#resObj.typeNums       = [resObj.typeNums[ix] for ix in typeIxs]</span>
    <span class="c">#resObj.typeMasses_amu = [resObj.typeMasses_amu[ix] for ix in typeIxs]</span>
    <span class="c">#resObj.typeValences   = [resObj.typeValences[ix] for ix in typeIxs]</span>
    <span class="c">#resObj.typePseudos    = [resObj.typePseudos[ix] for ix in typeIxs]</span>

    <span class="c">#if bugLev &gt;= 5:</span>
    <span class="c">#  print &#39;\nsorted atomTypes:&#39;</span>
    <span class="c">#  print &#39;typeIxs: %s&#39; % ( resObj.typeIxs,)</span>
    <span class="c">#  print &#39;typeNames: %s&#39; % ( resObj.typeNames,)</span>
    <span class="c">#  print &#39;typeNums: %s&#39; % ( resObj.typeNums,)</span>
    <span class="c">#  print &#39;typeMasses_amu: %s&#39; % ( resObj.typeMasses_amu,)</span>
    <span class="c">#  print &#39;typeValences: %s&#39; % ( resObj.typeValences,)</span>
    <span class="c">#  print &#39;typePseudos: %s&#39; % ( resObj.typePseudos,)</span>

    <span class="c">## Make sure typenames are in alphabetic order</span>
    <span class="c">#for ii in range(len(resObj.typeNames) - 1):</span>
    <span class="c">#  if resObj.typeNames[ii] &gt; resObj.typeNames[ii+1]:</span>
    <span class="c">#    throwerr(&#39;typeNames not in order&#39;)</span>

    <span class="c">## Make sure atomnames are in alphabetic order</span>
    <span class="c">#for ii in range(len(resObj.atomNames) - 1):</span>
    <span class="c">#  if resObj.atomNames[ii] &gt; resObj.atomNames[ii+1]:</span>
    <span class="c">#    throwerr(&#39;atomNames not in order&#39;)</span>


    <span class="c"># New way to get atomNames, atomMasses, atomValences, atomPseudos</span>

    <span class="n">resObj</span><span class="o">.</span><span class="n">atomNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">atomMasses_amu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">atomValences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">atomPseudos</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">numType</span><span class="p">):</span>
      <span class="n">nn</span> <span class="o">=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">[</span> <span class="n">ii</span><span class="p">]</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">atomNames</span> <span class="o">+=</span> <span class="n">nn</span> <span class="o">*</span> <span class="p">[</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">atomMasses_amu</span> <span class="o">+=</span> <span class="n">nn</span> <span class="o">*</span> <span class="p">[</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeMasses_amu</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">atomValences</span> <span class="o">+=</span> <span class="n">nn</span> <span class="o">*</span> <span class="p">[</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeValences</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">atomPseudos</span> <span class="o">+=</span> <span class="n">nn</span> <span class="o">*</span> <span class="p">[</span><span class="n">resObj</span><span class="o">.</span><span class="n">typePseudos</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
    <span class="n">numAtom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">atomNames</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">getInitialPositions</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getFinalPositionsForce</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">getStressMat</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getMagmoms</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getKpointMat</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getEigenMat</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">getDielectric</span><span class="p">(</span> <span class="n">resObj</span><span class="p">)</span>


    <span class="c"># Check that the POSCAR posScaleFactor agrees</span>
    <span class="c"># with the calculation we did in getKpointMat using OUTCAR.</span>
    <span class="c">#</span>
    <span class="c">#fname = os.path.join( self.inDir, &#39;POSCAR&#39;)</span>
    <span class="c">#with open( fname) as fin:</span>
    <span class="c">#  lines = fin.readlines()</span>
    <span class="c">#scalefac = float( lines[1].strip())</span>
    <span class="c">#print &#39;check scaleFactor: poscar: %g  outcar: %g  out-pos: %g&#39; \</span>
    <span class="c">#  % (scalefac, resObj.posScaleFactor, resObj.posScaleFactor - scalefac,)</span>

<span class="c">#====================================================================</span>

<div class="viewcode-block" id="ScanOutcar.parseIncar"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.parseIncar">[docs]</a>  <span class="k">def</span> <span class="nf">parseIncar</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts info from a VASP INCAR file, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">inDir</span><span class="p">,</span> <span class="s">&#39;INCAR&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
      <span class="n">lines</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">lines</span><span class="p">)):</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^([a-zA-Z0-9]+) *= *(.*)$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;invalid line.  iline: </span><span class="si">%d</span><span class="s">  line: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iline</span><span class="p">,</span> <span class="n">line</span><span class="p">,),</span>
            <span class="bp">None</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c"># Convert key to our nomenclature</span>
        <span class="n">keyMap</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s">&#39;ispin&#39;</span><span class="p">:</span> <span class="s">&#39;numSpin&#39;</span><span class="p">,</span>
          <span class="s">&#39;encut&#39;</span><span class="p">:</span> <span class="s">&#39;encut_ev&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">keyMap</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span> <span class="n">key</span><span class="p">):</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keyMap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">ix</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span>           <span class="c"># get rid of trailing comment</span>
        <span class="k">if</span> <span class="n">ix</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[:</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span>       <span class="c"># strip possibly unbalanced quotes</span>

        <span class="c"># Try to convert to int</span>
        <span class="n">isConv</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">val</span><span class="p">)</span>
          <span class="n">isConv</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
          <span class="k">pass</span>

        <span class="c"># Try to convert to float</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isConv</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">isConv</span> <span class="o">=</span> <span class="bp">True</span>
          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Try to convert to bool</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isConv</span><span class="p">:</span>
          <span class="n">tstg</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
          <span class="k">if</span> <span class="n">tstg</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">,</span> <span class="s">&#39;.false.&#39;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">isConv</span> <span class="o">=</span> <span class="bp">True</span>
          <span class="k">elif</span> <span class="n">tstg</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="s">&#39;true&#39;</span><span class="p">,</span> <span class="s">&#39;.true.&#39;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">isConv</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">resObj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&#39;parseIncar: </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,)</span>


<span class="c">#====================================================================</span>

<span class="c"># We no longer use the POSCAR file since everything</span>
<span class="c"># in it can be derived from the OUTCAR file.</span>

<span class="c"># Fills only a few values:</span>
<span class="c">#   resObj.posScaleFactor</span>
<span class="c">#   resObj.typeNames</span>
<span class="c">#   resObj.typeNums</span>
<span class="c">#</span>
<span class="c"># We get the initial positions from the OUTCAR</span>
<span class="c"># in getInitialPositions.</span>
</div>
<div class="viewcode-block" id="ScanOutcar.parsePoscar"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.parsePoscar">[docs]</a>  <span class="k">def</span> <span class="nf">parsePoscar</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts info from a VASP POSCAR file, setting resObj attributes.</span>
<span class="sd">    No longer used.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">inDir</span><span class="p">,</span> <span class="s">&#39;POSCAR&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
      <span class="n">lines</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">lines</span><span class="p">)):</span>
      <span class="n">lines</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">iline</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sysName</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span>   <span class="c"># strip possibly unbalanced quotes</span>
    <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">posScaleFactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">])</span>
    <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">basisList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
      <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;invalid basis.  iline: </span><span class="si">%d</span><span class="s">  line: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iline</span><span class="p">,</span> <span class="n">line</span><span class="p">,),</span>
          <span class="bp">None</span><span class="p">)</span>
      <span class="n">basisList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">))</span>
    <span class="n">basisMat</span> <span class="o">=</span> <span class="n">posScaleFactor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">basisList</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c"># typeNames</span>
    <span class="c"># This is not documented at</span>
    <span class="c"># http://cms.mpi.univie.ac.at/vasp/vasp/POSCAR_file.html</span>
    <span class="c"># Some POSCAR files have an inserted line with the typeNames.</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^\d+ .*$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>   <span class="c"># if no typeNames, we hit typeNums</span>
      <span class="n">typeNames</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>                            <span class="c"># else get typeNames</span>
      <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">typeNames</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c"># typeNums</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
    <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">typeNums</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">int</span><span class="p">,</span> <span class="n">toks</span><span class="p">)</span>

    <span class="c"># posType: &#39;direct&#39; or &#39;cartesian&#39;</span>
    <span class="n">posType</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c"># fracPosMat, cartPosMat</span>
    <span class="n">posList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">typeNums</span><span class="p">)):</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
      <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;invalid pos.  iline: </span><span class="si">%d</span><span class="s">  line: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iline</span><span class="p">,</span> <span class="n">line</span><span class="p">,),</span>
          <span class="bp">None</span><span class="p">)</span>
      <span class="n">posList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">))</span>
    <span class="n">posMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">posList</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">posType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;direct&#39;</span><span class="p">]:</span>
      <span class="n">fracPosMat</span> <span class="o">=</span> <span class="n">posMat</span>
      <span class="n">cartPosMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">fracPosMat</span><span class="p">,</span> <span class="n">basisMat</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">posType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;cartesian&#39;</span><span class="p">]:</span>
      <span class="n">cartPosMat</span> <span class="o">=</span> <span class="n">posMat</span> <span class="o">*</span> <span class="n">posScaleFactor</span>
      <span class="n">fracPosMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">cartPosMat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span> <span class="n">basisMat</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;unknown posType: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posType</span><span class="p">,),</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">resObj</span><span class="o">.</span><span class="n">posScaleFactor</span> <span class="o">=</span> <span class="n">posScaleFactor</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span> <span class="o">=</span> <span class="n">typeNames</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span> <span class="o">=</span> <span class="n">typeNums</span>
    <span class="c"># Ignore the matrix items in POSCAR, as they sometimes</span>
    <span class="c"># differ from OUTCAR and the word is that OUTCAR is correct.</span>
    <span class="c"># resObj.initialBasisMat = basisMat</span>
    <span class="c"># resObj.initialFracPosMat = directMat</span>
    <span class="c"># resObj.initialCartPosMat = cartMat</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;parsePoscar: posScaleFactor: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">posScaleFactor</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;parsePoscar: typeNames: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typeNames</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;parsePoscar: typeNums: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typeNums</span><span class="p">,)</span>



<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getScalars"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getScalars">[docs]</a>  <span class="k">def</span> <span class="nf">getScalars</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts scalars from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#   k-Points           NKPTS =     51   number of bands    NBANDS=     26</span>
    <span class="c"># or</span>
    <span class="c">#   k-points           NKPTS =    260   k-points in BZ     NKDIM =    260   number of bands    NBANDS=     11</span>
    <span class="n">nkpointPat</span> <span class="o">=</span> <span class="s">r&#39;^k-.oints +NKPTS *= *(\d+) .* number of bands +NBANDS *= *\d+$&#39;</span>
    <span class="n">nbandPat</span> <span class="o">=</span> <span class="s">r&#39;^k-.oints +NKPTS *= *\d+ .* number of bands +NBANDS *= *(\d+)$&#39;</span>

    <span class="c"># Specs for grepping some scalars from OUTCAR.</span>
    <span class="c"># Each spec has the fields:</span>
    <span class="c">#   tag       key for resObj.__dict__</span>
    <span class="c">#   pat       regular expression to match</span>
    <span class="c">#   which     which matched line to use: &#39;first&#39; first line, or &#39;last&#39;.</span>
    <span class="c">#   numMin    min num lines which must match pat</span>
    <span class="c">#   numMax    0 or max num lines which must match pat</span>
    <span class="c">#   tp        result type: int, float, or str</span>

    <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span>
      <span class="c"># EDIFF  = 0.6E-04   stopping-criterion for ELM</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;ediff&#39;</span><span class="p">,</span> <span class="s">r&#39;^EDIFF *= *([-.E0-9]+) *stopping-criterion.*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
      <span class="c"># ENCUT  =  340.0 eV  24.99 Ry    5.00 a.u. 4.51 4.51  4.51*2*pi/ulx,y,z</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;encut_ev&#39;</span><span class="p">,</span> <span class="s">r&#39;^ENCUT *= *([-.E0-9]+) eV .*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
      <span class="c"># IALGO  =     68    algorithm</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;ialgo&#39;</span><span class="p">,</span> <span class="s">r&#39;^IALGO *= *(\d+) +algorithm$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="c"># ALGO = Fast</span>
      <span class="c"># ALGO    =GW        execute GW part</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;algo&#39;</span><span class="p">,</span> <span class="s">r&#39;^ALGO *= *([a-zA-Z0-9]+).*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
      <span class="c"># IBRION =      2    ionic relax: 0-MD 1-quasi-New 2-CG</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;ibrion&#39;</span><span class="p">,</span> <span class="s">r&#39;^IBRION *= *([-0-9]+) +ionic relax *: .*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="c"># ICHARG =      0    charge: 1-file 2-atom 10-const</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;icharg&#39;</span><span class="p">,</span> <span class="s">r&#39;^ICHARG *= *(\d+) +charge *: .*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="c"># ISPIN  =      2    # 1: non spin polarized,  2: spin polarized</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;numSpin&#39;</span><span class="p">,</span> <span class="s">r&#39;^ISPIN *= *(\d+) +spin polarized .*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="c"># ISIF   =      3    stress and relaxation</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;isif&#39;</span><span class="p">,</span> <span class="s">r&#39;^ISIF *= *(\d+) +stress and relaxation$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="c"># ISMEAR and SIGMA from:</span>
      <span class="c">#   ISMEAR =   0; SIGMA  =  0.01  broadening in eV -4-tet -1-fermi 0-gaus</span>
      <span class="c">#   ISMEAR =   -5; SIGMA  =  0.20  broadening in eV -4-tet -1-fermi 0-gaus</span>

      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;ismear&#39;</span><span class="p">,</span>
        <span class="s">r&#39;^ *ISMEAR *= *([-0-9]+); +SIGMA *= *[-.E0-9]+ +broadening .*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;sigma&#39;</span><span class="p">,</span>
        <span class="s">r&#39;^ *ISMEAR *= *[-0-9]+; +SIGMA *= *([-.E0-9]+) +broadening .*$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
      <span class="c"># LDA+U is selected, type is set to LDAUTYPE =  2</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;ldautype&#39;</span><span class="p">,</span>
        <span class="s">r&#39;^ *LDA\+U is selected, type is set to LDAUTYPE *= *(\d+)$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="c"># NELECT =      14.0000    total number of electrons</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;numElectron&#39;</span><span class="p">,</span>
        <span class="s">r&#39;^NELECT *= *([-.E0-9]+) +total number of electrons$&#39;</span><span class="p">,</span>
        <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
      <span class="c"># k-points    NKPTS =    260   k-points in BZ     NKDIM =    260 \</span>
      <span class="c">#   number of bands    NBANDS=     13</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;numKpoint&#39;</span><span class="p">,</span> <span class="n">nkpointPat</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;numBand&#39;</span><span class="p">,</span>   <span class="n">nbandPat</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>

      <span class="c"># Volume</span>
      <span class="c">#   volume of cell :       20.0121</span>
      <span class="n">Sspec</span><span class="p">(</span> <span class="s">&#39;finalVolume_ang3&#39;</span><span class="p">,</span> <span class="s">r&#39;^volume of cell *: +([-.E0-9]+)$&#39;</span><span class="p">,</span>
        <span class="s">&#39;last&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>

    <span class="p">]</span> <span class="c"># specs</span>

    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
      <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">pat</span><span class="p">],</span> <span class="n">spec</span><span class="o">.</span><span class="n">numMin</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">numMax</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">which</span> <span class="o">==</span> <span class="s">&#39;first&#39;</span><span class="p">:</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">which</span> <span class="o">==</span> <span class="s">&#39;last&#39;</span><span class="p">:</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;invalid which in spec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spec</span><span class="p">,),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">tp</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c"># We can get a value from both parseIncar and OUTCAR</span>
        <span class="k">if</span> <span class="n">resObj</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span> <span class="n">spec</span><span class="o">.</span><span class="n">tag</span><span class="p">):</span>
          <span class="n">cmsg</span> <span class="o">=</span> <span class="n">wrapUpload</span><span class="o">.</span><span class="n">deepCompare</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span><span class="p">,</span> <span class="mf">1.e-15</span><span class="p">,</span>
            <span class="s">&#39;INCAR&#39;</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span> <span class="n">spec</span><span class="o">.</span><span class="n">tag</span><span class="p">],</span>
            <span class="s">&#39;OUTCAR&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">cmsg</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;value conflict (using OUTCAR): spec: </span><span class="si">%s</span><span class="s">  cmsg: </span><span class="si">%s</span><span class="s">&#39;</span> \
              <span class="o">%</span> <span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">,)</span>
            <span class="n">resObj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>    <span class="c"># override INCAR value</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">resObj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
          <span class="k">print</span> <span class="s">&#39;getScalars: </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">,)</span>



<span class="c">#====================================================================</span>

  <span class="c"># runDate</span>
  <span class="c">#   executed on             LinuxIFC date 2013.10.18  08:44:21</span></div>
<div class="viewcode-block" id="ScanOutcar.getDate"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getDate">[docs]</a>  <span class="k">def</span> <span class="nf">getDate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts runDate from OUTCAR, setting resObj.runDate.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^executed on .* date +\d{4}\.\d{2}\.\d{2} +\d{2}:\d{2}:\d{2}$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">stg</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">toks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">runDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span> <span class="n">stg</span><span class="p">,</span> <span class="s">&#39;%Y.%m.</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getDate: runDate: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">resObj</span><span class="o">.</span><span class="n">runDate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y.%m.</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">),)</span>

<span class="c">#====================================================================</span>

  <span class="c"># iterCpuTimes    (not in GW calcs)</span>
  <span class="c"># iterRealTimes   (not in GW calcs)</span>
  <span class="c"># Lines are like either of:</span>
  <span class="c">#   LOOP+:  cpu time   22.49: real time   24.43</span>
  <span class="c">#   LOOP+:  VPU time   42.93: CPU time   43.04</span>
  <span class="c">#   LOOP+:  cpu time16935.65: real time16944.21</span>
  <span class="c">#   LOOP+:  cpu time********: real time********</span>

  <span class="c"># In the second line, &quot;VPU&quot; means CPU, and &quot;CPU&quot; means wall time.</span>
  <span class="c"># See: http://cms.mpi.univie.ac.at/vasp-forum/forum_viewtopic.php?3.336</span>
  <span class="c">#</span>
  <span class="c"># In all calcs get:</span>
  <span class="c">#                 Total CPU time used (sec):       11.725</span>
  <span class="c">#                         User time (sec):        9.392</span>
  <span class="c">#                       System time (sec):        2.334</span>
  <span class="c">#                      Elapsed time (sec):       14.468</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getTimes"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getTimes">[docs]</a>  <span class="k">def</span> <span class="nf">getTimes</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts timing info from OUTCAR, setting attrs in resObj.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^LOOP\+ *: +[a-zA-Z]+ +time *([.0-9]+): +[a-zA-Z]+&#39;</span> \
      <span class="o">+</span> <span class="s">r&#39; +time *([.0-9]+)$&#39;</span>

    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">iterCpuTimes</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">iterRealTimes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">cpuTimes</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">realTimes</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ixs</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
        <span class="n">cpuTimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">realTimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">iterCpuTimes</span> <span class="o">=</span> <span class="n">cpuTimes</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">iterRealTimes</span> <span class="o">=</span> <span class="n">realTimes</span>

    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^Total CPU time used \(sec\): +([.0-9]+)$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">totalCpuTimeSec</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^User time \(sec\): +([.0-9]+)$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">userTimeSec</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^System time \(sec\): +([.0-9]+)$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">systemTimeSec</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^Elapsed time \(sec\): +([.0-9]+)$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">elapsedTimeSec</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getTimes: iterCpuTimes: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">iterCpuTimes</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getTimes: iterRealTimes: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">iterRealTimes</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getTimes: totalCpuTimeSec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">totalCpuTimeSec</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getTimes: userTimeSec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">userTimeSec</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getTimes: systemTimeSec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">systemTimeSec</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getTimes: elapsedTimeSec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">elapsedTimeSec</span><span class="p">,)</span>


<span class="c">#====================================================================</span>

  <span class="c"># angular momentum for each species, LDAU#  1 :   L =       2     -1</span>
  <span class="c"># U (eV)           for each species, LDAU#  1 :   U =   -2.40   0.00</span>
  <span class="c"># J (eV)           for each species, LDAU#  1 :   J =    0.00   0.00</span>
  <span class="c"># nlep             for each species, LDAU#  1 :   O =       2      1</span>
  <span class="c"># angular momentum for each species, LDAU#  2 :   L =      -1     -1</span>
  <span class="c"># U (eV)           for each species, LDAU#  2 :   U =    0.00   0.00</span>
  <span class="c"># J (eV)           for each species, LDAU#  2 :   J =    0.00   0.00</span>
  <span class="c"># nlep             for each species, LDAU#  2 :   O =       1      1</span>
  <span class="c"># angular momentum for each species, LDAU#  3 :   L =      -1     -1</span>
  <span class="c"># U (eV)           for each species, LDAU#  3 :   U =    0.00   0.00</span>
  <span class="c"># J (eV)           for each species, LDAU#  3 :   J =    0.00   0.00</span>
  <span class="c"># nlep             for each species, LDAU#  3 :   O =       1      1</span>
  <span class="c"># angular momentum for each species, LDAU#  4 :   L =      -1     -1</span>
  <span class="c"># U (eV)           for each species, LDAU#  4 :   U =    0.00   0.00</span>
  <span class="c"># J (eV)           for each species, LDAU#  4 :   J =    0.00   0.00</span>
  <span class="c"># nlep             for each species, LDAU#  4 :   O =       1      1</span>
</div>
  <span class="k">def</span> <span class="nf">getLdau</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">numType</span><span class="p">,</span>         <span class="c"># num atomic types</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts LDAU info from OUTCAR, setting attrs in resObj.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39; *angular momentum +for each species, LDAU# *(\d+) *: *L *=.*$&#39;</span>

    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">numLdau</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">ixs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">numLdau</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">ldaul_mat</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># numLdau * numType</span>
      <span class="n">ldauu_mat</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># numLdau * numType</span>
      <span class="n">ldauj_mat</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># numLdau * numType</span>
      <span class="n">ldauo_mat</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># numLdau * numType</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ldaul_mat</span> <span class="o">=</span> <span class="n">numLdau</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>   <span class="c"># numLdau * numType</span>
      <span class="n">ldauu_mat</span> <span class="o">=</span> <span class="n">numLdau</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>   <span class="c"># numLdau * numType</span>
      <span class="n">ldauj_mat</span> <span class="o">=</span> <span class="n">numLdau</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>   <span class="c"># numLdau * numType</span>
      <span class="n">ldauo_mat</span> <span class="o">=</span> <span class="n">numLdau</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>   <span class="c"># numLdau * numType</span>

      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)):</span>
        <span class="c"># Get LDAUL line</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^ *angular momentum +for each species, LDAU# +\d+ *: *L *= .*$&#39;</span><span class="p">,</span>
          <span class="n">line</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldaul pat mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">numType</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldaul len mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldaul grp mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">int</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">10</span><span class="p">:])</span>
        <span class="n">ldaul_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

        <span class="c"># Get LDAUU line</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^ *U \(eV\) +for each species, LDAU# +\d+ *: *U *= .*$&#39;</span><span class="p">,</span>
          <span class="n">line</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauu pat mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">numType</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauu len mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauu grp mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">10</span><span class="p">:])</span>
        <span class="n">ldauu_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

        <span class="c"># Get LDAUJ line</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^ *J \(eV\) +for each species, LDAU# +\d+ *: *J *= .*$&#39;</span><span class="p">,</span>
          <span class="n">line</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauj pat mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">numType</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauj len mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauj grp mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">10</span><span class="p">:])</span>
        <span class="n">ldauj_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

        <span class="c"># Get LDAUO line, if any</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^ *nlep +for each species, LDAU# +\d+ *: *O *= .*$&#39;</span><span class="p">,</span>
          <span class="n">line</span><span class="p">):</span>
          <span class="n">ldauo_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">9</span> <span class="o">+</span> <span class="n">numType</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauo len mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">!=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;ldauo grp mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
          <span class="n">vals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">int</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">9</span><span class="p">:])</span>
          <span class="n">ldauo_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;getLdau: raw ldaul_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ldaul_mat</span><span class="p">,)</span>
        <span class="k">print</span> <span class="s">&#39;getLdau: raw ldauu_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ldauu_mat</span><span class="p">,)</span>
        <span class="k">print</span> <span class="s">&#39;getLdau: raw ldauj_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ldauj_mat</span><span class="p">,)</span>
        <span class="k">print</span> <span class="s">&#39;getLdau: raw ldauo_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ldauo_mat</span><span class="p">,)</span>

      <span class="n">ldaul_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ldaul_mat</span><span class="p">)</span>
      <span class="n">ldauu_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ldauu_mat</span><span class="p">)</span>
      <span class="n">ldauj_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ldauj_mat</span><span class="p">)</span>
      <span class="n">ldauo_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">ldauo_mat</span><span class="p">)</span>

    <span class="n">resObj</span><span class="o">.</span><span class="n">ldaul_mat</span> <span class="o">=</span> <span class="n">ldaul_mat</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">ldauu_mat</span> <span class="o">=</span> <span class="n">ldauu_mat</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">ldauj_mat</span> <span class="o">=</span> <span class="n">ldauj_mat</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">ldauo_mat</span> <span class="o">=</span> <span class="n">ldauo_mat</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getLdau: ldaul_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">ldaul_mat</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getLdau: ldauu_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">ldauu_mat</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getLdau: ldauj_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">ldauj_mat</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getLdau: ldauo_mat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">ldauo_mat</span><span class="p">,)</span>

<span class="c">#====================================================================</span>

  <span class="c"># system</span>
  <span class="c">#   SYSTEM =  icsd_633029 in icsd_633029.cif, hs-ferr</span>
<div class="viewcode-block" id="ScanOutcar.getSystem"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getSystem">[docs]</a>  <span class="k">def</span> <span class="nf">getSystem</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts systemName from OUTCAR, setting resObj.systemName</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^SYSTEM *= &#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">nm</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\&quot;\&#39;</span><span class="s">&#39;</span><span class="p">)</span>   <span class="c"># strip unpaired surrounding quotes</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">systemName</span> <span class="o">=</span> <span class="n">nm</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getSystem: systemName: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">systemName</span><span class="p">,)</span>

<span class="c">#====================================================================</span>

  <span class="c"># For doc on ALGO see:</span>
  <span class="c"># http://cms.mpi.univie.ac.at/vasp/vasp/Recipe_selfconsistent_GW_calculations.html</span>
  <span class="c"># http://cms.mpi.univie.ac.at/vasp/vasp/Recipe_GW_calculations.html</span>
  <span class="c"># http://cms.mpi.univie.ac.at/wiki/index.php/ALGO</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getCategEnergy"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getCategEnergy">[docs]</a>  <span class="k">def</span> <span class="nf">getCategEnergy</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts energyNoEntrps, efermi0 from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># Spacing varies:</span>
    <span class="c"># energy without entropy =  -60.501550  energy(sigma-&gt;0) =  -60.501640</span>
    <span class="c"># energy  without entropy=  -15.051005  energy(sigma-&gt;0) =  -15.051046</span>

    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^energy +without +entropy *= *([-.E0-9]+)&#39;</span> \
      <span class="o">+</span> <span class="s">r&#39; +energy\(sigma-&gt;0\) *= *[-.E0-9]+$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">energyNoEntrps</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">efermi0</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">energyNoEntrps</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ixs</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
        <span class="n">resObj</span><span class="o">.</span><span class="n">energyNoEntrps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

      <span class="c">#   E-fermi :   6.5043     XC(G=0): -12.1737     alpha+bet :-11.7851</span>
      <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^E-fermi *: *([-.E0-9]+) +XC.*alpha\+bet.*$&#39;</span>
      <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
      <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">efermi0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c">#====================================================================</span>

  <span class="c"># initialBasisMat, finalBasisMat == cell</span>
  <span class="c">#   direct lattice vectors                 reciprocal lattice vectors</span>
  <span class="c">#   0.0004124  2.1551750  2.1553184    -0.2320833  0.2320088  0.2320195</span>
  <span class="c">#   2.1551376  0.0004322  2.1552987     0.2320129 -0.2320836  0.2320237</span>
  <span class="c">#   2.1548955  2.1549131  0.0006743     0.2320650  0.2320652 -0.2320942</span></div>
<div class="viewcode-block" id="ScanOutcar.getBasisMats"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getBasisMats">[docs]</a>  <span class="k">def</span> <span class="nf">getBasisMats</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts basis matrices from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^direct lattice vectors +reciprocal lattice vectors$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># initial</span>
    <span class="n">initialBasisMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
      <span class="mi">6</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>       <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="n">initialRecipBasisMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
      <span class="mi">6</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>       <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>

    <span class="c"># The basisMats can differ from POSCAR by 1.e-1 or so.  Why?</span>
    <span class="c"># Use the OUTCAR version.</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">initialBasisMat</span> <span class="o">=</span> <span class="n">initialBasisMat</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span> <span class="o">=</span> <span class="n">initialRecipBasisMat</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># final</span>
    <span class="c"># In vasprun.xml and OUTCAR, the basis vectors are rows.</span>
    <span class="c"># In PyLada, Mayeul uses the transpose.</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">finalBasisMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
      <span class="mi">6</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>       <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">finalRecipBasisMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
      <span class="mi">6</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>       <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>

    <span class="c"># Test the linear algebra</span>
    <span class="n">test_initialRecip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialBasisMat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">test_finalRecip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalBasisMat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getBasisMats: initialBasisMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialBasisMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getBasisMats: initialRecipBasisMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getBasisMats: test_initialRecip:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">test_initialRecip</span><span class="p">),)</span>

      <span class="k">print</span> <span class="s">&#39;getBasisMats: finalBasisMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalBasisMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getBasisMats: finalRecipBasisMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalRecipBasisMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getBasisMats: test_finalRecip:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">test_finalRecip</span><span class="p">),)</span>

    <span class="c"># Test the linear algebra</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">checkClose</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="p">,</span> <span class="n">test_initialRecip</span><span class="p">,</span> <span class="mf">1.e-3</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">checkClose</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalRecipBasisMat</span><span class="p">,</span> <span class="n">test_finalRecip</span><span class="p">,</span> <span class="mf">1.e-3</span><span class="p">)</span>

<span class="c">#====================================================================</span>

  <span class="c"># typeNames == species</span>
  <span class="c"># All lines like:</span>
  <span class="c">#   VRHFIN =Fe:  d7 s1</span>
  <span class="c">#   VRHFIN =O: s2p4</span>
  <span class="c">#   VRHFIN =O : s2p4</span>
  <span class="c">#   VRHFIN =Ni:</span>
  <span class="c">#</span>
  <span class="c"># Other possible patterns we could use, but currently do not.</span>
  <span class="c">#   POTCAR:   PAW_PBE Zn 06Sep2000    # no, repeated</span>
  <span class="c">#   TITEL  = PAW_PBE Zn 06Sep2000</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getTypeNames"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getTypeNames">[docs]</a>  <span class="k">def</span> <span class="nf">getTypeNames</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts typeNames from OUTCAR, setting resObj attribute.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^VRHFIN *= *([a-zA-Z]+) *:&#39;</span>

    <span class="n">regexa</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="n">pat</span><span class="p">)</span>
    <span class="n">typeNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">numLine</span><span class="p">):</span>
      <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
      <span class="n">mat</span> <span class="o">=</span> <span class="n">regexa</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">line</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">mat</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">typeNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c"># If POSCAR didn&#39;t have typeNames</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span> <span class="n">resObj</span><span class="p">,</span> <span class="s">&#39;typeNames&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span> <span class="o">=</span> <span class="n">typeNames</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">typeNames</span> <span class="o">!=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;typeNames mismatch.  POSCAR: </span><span class="si">%s</span><span class="s">  OUTCAR: </span><span class="si">%s</span><span class="s">&#39;</span> \
          <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span><span class="p">,</span> <span class="n">typeNames</span><span class="p">,),</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getTypeNames: typeNames: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeNames</span><span class="p">,)</span>

<span class="c">#====================================================================</span>

  <span class="c"># typeNums == stoichiometry</span>
  <span class="c">#   ions per type =               1   1</span></div>
<div class="viewcode-block" id="ScanOutcar.getTypeNums"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getTypeNums">[docs]</a>  <span class="k">def</span> <span class="nf">getTypeNums</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts typeNums (ions per type) from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^ions per type *= &#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">toks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">typeNums</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">int</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

    <span class="c"># If POSCAR didn&#39;t have typeNums</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span> <span class="n">resObj</span><span class="p">,</span> <span class="s">&#39;typeNums&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span> <span class="o">=</span> <span class="n">typeNums</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">typeNums</span> <span class="o">!=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;typeNums mismatch.  POSCAR: </span><span class="si">%s</span><span class="s">  OUTCAR: </span><span class="si">%s</span><span class="s">&#39;</span> \
          <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">,</span> <span class="n">typeNums</span><span class="p">,),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getTypeNums: typeNums: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeNums</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getTypeNums: numAtom: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span><span class="p">,)</span>

<span class="c">#====================================================================</span>

  <span class="c"># initialFracPosMat, initialCartPosMat</span>
  <span class="c">#   position of ions in fractional coordinates (direct lattice)</span>
  <span class="c">#     0.00000005  0.99999999  0.99999997</span>
  <span class="c">#     0.49999995  0.50000001  0.50000003</span>
  <span class="c">#</span>
  <span class="c">#   position of ions in cartesian coordinates  (Angst):</span>
  <span class="c">#     4.24342506  2.12183357  2.12263079</span>
  <span class="c">#     2.12184258  2.12186596  2.12233823</span></div>
<div class="viewcode-block" id="ScanOutcar.getInitialPositions"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getInitialPositions">[docs]</a>  <span class="k">def</span> <span class="nf">getInitialPositions</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts initial position matrices from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">patf</span> <span class="o">=</span> <span class="s">r&#39;^position of ions in fractional coordinates \(direct lattice\)$&#39;</span>
    <span class="n">patc</span> <span class="o">=</span> <span class="s">r&#39;^position of ions in cartesian coordinates +\(Angst\):$&#39;</span>

    <span class="c"># Get initialFracPosMat</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">patf</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># pats, numMin, numMax</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">initialFracPosMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
      <span class="mi">3</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="c"># The posMats in OUTCAR and POSCAR can differ by 1.e-1 or so.  Why?</span>
    <span class="c"># Use the OUTCAR version.</span>

    <span class="c"># Get initialCartPosMat</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">patc</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c"># pats, numMin, numMax</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">initialCartPosMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
      <span class="mi">3</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
      <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="c"># The posMats in OUTCAR and POSCAR can differ by 1.e-1 or so.  Why?</span>
    <span class="c"># Use the OUTCAR version.</span>

    <span class="c"># Test the linear algebra</span>
    <span class="n">test_initialFracPosMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">initialCartPosMat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialBasisMat</span><span class="p">))</span>
    <span class="n">test_initialCartPosMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">initialFracPosMat</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialBasisMat</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">checkClose</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialFracPosMat</span><span class="p">,</span> <span class="n">test_initialFracPosMat</span><span class="p">,</span> <span class="mf">1.e-3</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">checkClose</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialCartPosMat</span><span class="p">,</span> <span class="n">test_initialCartPosMat</span><span class="p">,</span> <span class="mf">1.e-3</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getInitialPositions: initialFracPosMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatMatrix</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialFracPosMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getInitialPositions: initialCartPosMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatMatrix</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialCartPosMat</span><span class="p">),)</span>


<span class="c">#====================================================================</span>

  <span class="c"># finalCartPosMat, forceMat</span>
  <span class="c">#   POSITION                       TOTAL-FORCE (eV/Angst)</span>
  <span class="c">#   ------------------------------------------------------------------</span>
  <span class="c">#   0.59671  5.05062  2.21963       0.003680   -0.001241  -0.004039</span>
  <span class="c">#   4.98024  2.21990  0.58287       -0.000814  -0.015091  -0.012495</span>
  <span class="c">#   2.23430  0.66221  5.03287       0.017324   0.003318   -0.014394</span>
  <span class="c">#   ...</span>
  <span class="c">#   ------------------------------------------------------------------</span>
  <span class="c">#</span>
  <span class="c"># Not found in gw calcs.</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getFinalPositionsForce"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getFinalPositionsForce">[docs]</a>  <span class="k">def</span> <span class="nf">getFinalPositionsForce</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts final positions and forces from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^POSITION +TOTAL-FORCE \(eV/Angst\)$&#39;</span>

    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>     <span class="c"># pats, numMin, numMax</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalFracPosMat</span> <span class="o">=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialFracPosMat</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalCartPosMat</span> <span class="o">=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialCartPosMat</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalForceMat_ev_ang</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>    <span class="c"># last one</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalCartPosMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
        <span class="mi">6</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalForceMat_ev_ang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
        <span class="mi">6</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>

      <span class="n">resObj</span><span class="o">.</span><span class="n">finalFracPosMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
        <span class="n">resObj</span><span class="o">.</span><span class="n">finalCartPosMat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalBasisMat</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getFinalPositionsForce: finalCartPosMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatMatrix</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalCartPosMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getFinalPositionsForce: finalFracPosMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatMatrix</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalFracPosMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getFinalPositionsForce: finalForceMat_ev_ang:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatMatrix</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalForceMat_ev_ang</span><span class="p">),)</span>

<span class="c">#====================================================================</span>

  <span class="c"># stressMat</span>
  <span class="c">#   FORCE on cell =-STRESS in cart. coord.  units (eV):</span>
  <span class="c">#   Direction    XX         YY         ZZ        XY        YZ        ZX</span>
  <span class="c">#   -----------------------------------------------------------------------</span>
  <span class="c">#   Alpha Z    76.60341   76.60341   76.60341</span>
  <span class="c">#   Ewald    -318.46783 -318.46428 -318.52959  -0.00310   0.03083   0.02783</span>
  <span class="c">#   Hartree    63.38495   63.38593   63.35616   0.00114   0.01511   0.01368</span>
  <span class="c">#   E(xc)     -70.45894  -70.45888  -70.45878  -0.00052  -0.00008  -0.00008</span>
  <span class="c">#   Local       3.47019    3.46661    3.56011  -0.00319  -0.04620  -0.04172</span>
  <span class="c">#   n-local    -6.52091   -6.52080   -6.52183  -0.00373  -0.00131  -0.00134</span>
  <span class="c">#   augment    82.46862   82.46871   82.46910   0.00638   0.00129   0.00151</span>
  <span class="c">#   Kinetic   170.67238  170.67209  170.67398   0.00710   0.00098   0.00116</span>
  <span class="c">#   Fock        0.00000    0.00000    0.00000   0.00000   0.00000   0.00000</span>
  <span class="c">#   -----------------------------------------------------------------------</span>
  <span class="c">#   Total       1.15189    1.15278    1.15256   0.00410   0.00063   0.00105</span>
  <span class="c">#   in kB      96.62361   96.69864   96.68018   0.34362   0.05255   0.08820</span>
  <span class="c">#   external pressure =       96.67 kB  Pullay stress =        0.00 kB</span>
  <span class="c">#</span>
  <span class="c"># Not in gw calcs.</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getStressMat"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getStressMat">[docs]</a>  <span class="k">def</span> <span class="nf">getStressMat</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts final stress matrix from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^FORCE on cell *= *-STRESS in cart. coord. +units \(eV\) *:$&#39;</span>

    <span class="c"># In some non-GW calcs with ALGO=DIAG there is no stress matrix.</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalStressMat_ev</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalStressMat_kbar</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>    <span class="c"># last one</span>

      <span class="c"># Find the &quot;Total&quot; and &quot;in kB&quot; lines</span>
      <span class="n">evline</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">kbline</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">16</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^Total( +[-.E0-9]+){6}$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span> <span class="n">evline</span> <span class="o">=</span> <span class="n">ii</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^in kB( +[-.E0-9]+){6}$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span> <span class="n">kbline</span> <span class="o">=</span> <span class="n">ii</span>
      <span class="k">if</span> <span class="n">evline</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;unknown stress ev&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">kbline</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;unknown stress kb&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>

      <span class="c"># Extract tokens from the &quot;Total&quot; and &quot;in kB&quot; lines</span>
      <span class="n">evtoks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span> <span class="n">evline</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c"># skip &#39;Total&#39;</span>
      <span class="n">kbtoks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span> <span class="n">kbline</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c"># skip &#39;in kB&#39;</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">evtoks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;unknown stress evtoks&#39;</span><span class="p">,</span> <span class="n">evline</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">kbtoks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;unknown stress kbtoks&#39;</span><span class="p">,</span> <span class="n">kbline</span><span class="p">)</span>
      <span class="n">evs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">evtoks</span><span class="p">)</span>
      <span class="n">kbs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">kbtoks</span><span class="p">)</span>

      <span class="c"># Create 3x3 matrices for ev and kb stress</span>
      <span class="n">evstress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
      <span class="n">kbstress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
      <span class="c"># Add in the terms XX, YY, ZZ</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">evstress</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="n">evs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">kbstress</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="n">kbs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
      <span class="n">evstress</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">evstress</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">evs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>    <span class="c"># XY</span>
      <span class="n">kbstress</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbstress</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>    <span class="c"># XY</span>
      <span class="n">evstress</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">evstress</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">evs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>    <span class="c"># XY</span>
      <span class="n">kbstress</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbstress</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>    <span class="c"># XY</span>
      <span class="n">evstress</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">evstress</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">evs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>    <span class="c"># YZ</span>
      <span class="n">kbstress</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbstress</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>    <span class="c"># YZ</span>

      <span class="n">resObj</span><span class="o">.</span><span class="n">finalStressMat_ev</span> <span class="o">=</span> <span class="n">evstress</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">finalStressMat_kbar</span> <span class="o">=</span> <span class="n">kbstress</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getStressMat: finalStressMat_ev:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatMatrix</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalStressMat_ev</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;getStressMat: finalStressMat_kbar:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatMatrix</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">finalStressMat_kbar</span><span class="p">),)</span>

<span class="c">#====================================================================</span>

  <span class="c">## Old typeValences == ionic_charges</span>
  <span class="c">##    ZVAL   =   8.00  6.00</span>
  <span class="c">#def getTypeValencesUnused( self, resObj):</span>
  <span class="c">#  pat = r&#39;^ZVAL *= &#39;</span>
  <span class="c">#  ixs = self.findLines( [pat], 1, 1)        # pats, numMin, numMax</span>
  <span class="c">#  toks = self.lines[ixs[0]].split()</span>
  <span class="c">#  resObj.typeValences = map( float, toks[2:])</span>

<span class="c">#====================================================================</span>

  <span class="c"># typeMasses, typeValences</span>
  <span class="c">#   POMASS =   55.847; ZVAL   =    8.000    mass and valenz</span>
  <span class="c">#   POMASS =   16.000; ZVAL   =    6.000    mass and valenz</span>
  <span class="c">#   POMASS =  55.85 16.00  # ignore this</span>
  <span class="c">#</span></div>
<div class="viewcode-block" id="ScanOutcar.getTypeMassValence"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getTypeMassValence">[docs]</a>  <span class="k">def</span> <span class="nf">getTypeMassValence</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts masses and valences from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^POMASS *= *([.0-9]+); +ZVAL += +([.0-9]+) +mass and valenz&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">typeMasses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">typeValences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ixs</span><span class="p">:</span>
      <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
      <span class="n">typeMasses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
      <span class="n">typeValences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">typeMasses_amu</span> <span class="o">=</span> <span class="n">typeMasses</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">typeValences</span> <span class="o">=</span> <span class="n">typeValences</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getTypeMassValence: typeMasses_amu: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeMasses_amu</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getTypeMassValence: typeValences: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">typeValences</span><span class="p">,)</span>

<span class="c">#====================================================================</span>

  <span class="c"># typePseudos</span>
  <span class="c">#   TITEL  = PAW_PBE Fe 06Sep2000</span>
  <span class="c">#   TITEL  = PAW_PBE O_s 07Sep2000</span></div>
<div class="viewcode-block" id="ScanOutcar.getTypePseudos"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getTypePseudos">[docs]</a>  <span class="k">def</span> <span class="nf">getTypePseudos</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts pseudopotential names from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^TITEL *= *(PAW.*)$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="n">typePseudos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ixs</span><span class="p">:</span>
      <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">pat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
      <span class="n">typePseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">typePseudos</span> <span class="o">=</span> <span class="n">typePseudos</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getTypePseudos: typePseudos: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">typePseudos</span><span class="p">,)</span>


<span class="c">#====================================================================</span>

  <span class="c"># Magmom, magnetic moment, magnetization:</span>
  <span class="c"># Returns the &#39;tot&#39; column.</span>
  <span class="c"># Not in vasp 4.6.</span>
  <span class="c">#</span>
  <span class="c">#      magnetization (x)</span>
  <span class="c">#</span>
  <span class="c">#     # of ion     s       p       d       tot</span>
  <span class="c">#     ----------------------------------------</span>
  <span class="c">#       1       -0.017  -0.008  -1.935  -1.960</span>
  <span class="c">#       2       -0.005  -0.006   0.000  -0.011</span>
  <span class="c">#     ------------------------------------------------</span>
  <span class="c">#     tot       -0.022  -0.014  -1.935  -1.970</span>
  <span class="c">#</span>
  <span class="c"># But if there is only one atom there is no &quot;tot&quot; line:</span>
  <span class="c">#      magnetization (x)</span>
  <span class="c">#</span>
  <span class="c">#    # of ion     s       p       d       tot</span>
  <span class="c">#    ----------------------------------------</span>
  <span class="c">#      1       -0.008  -0.014   0.549   0.526</span>
  <span class="c">#    (blank line)</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getMagmoms"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getMagmoms">[docs]</a>  <span class="k">def</span> <span class="nf">getMagmoms</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts magnetic moments from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^ *magnetization +\(x\)$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>        <span class="c"># pats, numMin, numMax</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">magmoms</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>           <span class="c"># use the last one</span>
      <span class="n">ix</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>               <span class="c"># skip over header &#39;magnetization (x)&#39;</span>

      <span class="c"># Skip over blank lines</span>
      <span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">numLine</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="c"># Skip over title &#39;# of ion&#39; and &#39;-----&#39;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;# of ion &#39;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-----&#39;</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;magmom format unknown&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
      <span class="n">ix</span> <span class="o">+=</span> <span class="mi">2</span>

      <span class="c"># Get data lines</span>
      <span class="n">magmomTots</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">numLine</span> \
        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> \
        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-----&#39;</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="c"># Get two groups: ionNum, restOfLine</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^ *(\d+)( +[-.0-9]+)+ *$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mat</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;magmom format unknown&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>
        <span class="n">ionNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">magStgs</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">magvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">magStgs</span><span class="p">)</span>
        <span class="n">magmomTots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">magvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>   <span class="c"># just keep the tot column</span>
        <span class="n">ix</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">magmomTots</span><span class="p">)</span> <span class="o">!=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numAtom</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;magmom num mismatch&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span>

      <span class="n">resObj</span><span class="o">.</span><span class="n">magmoms</span> <span class="o">=</span> <span class="n">magmomTots</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getMagmoms: magmoms: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">magmoms</span><span class="p">,)</span>

<span class="c">#====================================================================</span>

  <span class="c"># kpointFracMat, kpointCartMat,</span>
  <span class="c"># kpointMults, kpointWeights == normalized kpointMults</span>
  <span class="c">#   Found    260 irreducible k-points:</span>
  <span class="c">#</span>
  <span class="c">#   Following reciprocal coordinates:</span>
  <span class="c">#              Coordinates               Weight</span>
  <span class="c">#    0.000000  0.000000  0.000000      1.000000</span>
  <span class="c">#    0.125000  0.000000  0.000000      2.000000</span>
  <span class="c">#    0.250000  0.000000  0.000000      2.000000</span>
  <span class="c">#    ...</span>
  <span class="c">#    0.500000  0.500000  0.500000      1.000000</span>
  <span class="c">#</span>
  <span class="c">#   Following cartesian coordinates:</span>
  <span class="c">#              Coordinates               Weight</span>
  <span class="c">#    0.000000  0.000000  0.000000      1.000000</span>
  <span class="c">#   -0.029463  0.029454  0.029457      2.000000</span>
  <span class="c">#   -0.058925  0.058909  0.058914      2.000000</span>
  <span class="c">#    ...</span>
  <span class="c">#    0.117822  0.117821  0.117795      1.000000</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getKpointMat"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getKpointMat">[docs]</a>  <span class="k">def</span> <span class="nf">getKpointMat</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts kpoints, weights, mults from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">headPat</span>  <span class="o">=</span> <span class="s">r&#39;^Found +\d+ +irreducible k-points *:$&#39;</span>
    <span class="n">blankPat</span> <span class="o">=</span> <span class="s">r&#39;^$&#39;</span>
    <span class="n">recipPat</span> <span class="o">=</span> <span class="s">r&#39;^Following reciprocal coordinates *:$&#39;</span>
    <span class="n">cartPat</span>  <span class="o">=</span> <span class="s">r&#39;^Following cartesian coordinates *:$&#39;</span>
    <span class="n">wtPat</span>    <span class="o">=</span> <span class="s">r&#39;^Coordinates +Weight$&#39;</span>
    <span class="n">numKpoint</span> <span class="o">=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numKpoint</span>

    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span>
      <span class="p">[</span><span class="n">headPat</span><span class="p">,</span> <span class="n">blankPat</span><span class="p">,</span> <span class="n">recipPat</span><span class="p">,</span> <span class="n">wtPat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c"># pats, numMin, numMax</span>

    <span class="c"># Get kpointFracMat == generated reciprocol fractional coords.</span>
    <span class="c"># This is what vasprun.xml calls &quot;kpoints&quot;.</span>
    <span class="c"># If there are multiple occurances use the first.</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span>               <span class="c"># start of matrix</span>
    <span class="n">kpMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>     <span class="c"># kpoints and weights (multiplicities)</span>
      <span class="mi">4</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="n">numKpoint</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">kpointFracMat</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">kpMults</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">kpointMults</span> <span class="o">=</span> <span class="n">kpMults</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">kpointWeights</span> <span class="o">=</span> <span class="n">kpMults</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">kpMults</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: gen frac: kpointMults: </span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointMults</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: gen frac: kpointWeights: </span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointWeights</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: gen frac: kpointFracMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointFracMat</span><span class="p">,)</span>

    <span class="c"># Get generated cartesian coords</span>
    <span class="n">ixCart</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">numKpoint</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">cartPat</span><span class="p">,</span> <span class="n">wtPat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c"># pats, numMin, numMax</span>
    <span class="k">if</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ixCart</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;kpoint format&#39;</span><span class="p">,</span> <span class="n">ixCart</span><span class="p">)</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixCart</span> <span class="o">+</span> <span class="mi">2</span>              <span class="c"># start of matrix</span>
    <span class="n">kpMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>    <span class="c"># kpoints and weights (multiplicities)</span>
      <span class="mi">4</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="n">numKpoint</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">kpointCartMat</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">test_kpointMults</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">checkClose</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">kpointMults</span><span class="p">,</span> <span class="n">test_kpointMults</span><span class="p">,</span> <span class="mf">1.e-3</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: gen frac: test_kpointMults: </span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">test_kpointMults</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: gen cart: kpointCartMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointCartMat</span><span class="p">,)</span>

    <span class="c"># Back-calculate the posScaleFactor, method A,</span>
    <span class="c"># using kpointFracMat.</span>
    <span class="c"># We use method B, further below, to set resObj.posScaleFactor.</span>
    <span class="c">#</span>
    <span class="c"># We should have:</span>
    <span class="c">#   kpointCartMat == posScaleFactor * np.dot(</span>
    <span class="c">#     kpointFracMat, initialRecipBasisMat)</span>
    <span class="c">#</span>
    <span class="c"># So posScaleFactor = median( kpointCartMat / dotProd)</span>

    <span class="n">dotProd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">kpointFracMat</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="p">)</span>
    <span class="n">maskDotProd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span> <span class="n">dotProd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">maskKpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">kpointCartMat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskDotProd</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: kpointFracMat shape: </span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointFracMat</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: kpointCartMat shape: </span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointCartMat</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: initialRecipBasisMat shape: </span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: dotProd shape: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dotProd</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>

    <span class="n">ratioMat</span> <span class="o">=</span> <span class="n">maskKpoint</span> <span class="o">/</span> <span class="n">maskDotProd</span>
    <span class="n">ratioMean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: posScaleFrac ratio method A:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMat</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  A: ratioMean:   </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMean</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  A: ratioMedian: </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMedian</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  A: ratioMin:    </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMin</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  A: ratioMax:    </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMax</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  A: ratioDelta:  </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMax</span> <span class="o">-</span> <span class="n">ratioMin</span><span class="p">,)</span>

    <span class="c"># Get the actual kpoints</span>
    <span class="c">#</span>
    <span class="c">#     k-points in units of 2pi/SCALE and weight:</span>
    <span class="c">#  or k-points in units of 2pi/SCALE and weight: Automatic generation</span>
    <span class="c">#     0.00000000  0.00000000  0.00000000       0.016</span>
    <span class="c">#     0.08286762 -0.04784364  0.00000000       0.094</span>
    <span class="c">#     ...</span>
    <span class="c">#     0.16573524  0.00000000  0.15507665       0.094</span>
    <span class="c">#</span>
    <span class="c">#     k-points in reciprocal lattice and weights:</span>
    <span class="c">#  or k-points in reciprocal lattice and weights: Automatic generation</span>
    <span class="c">#     0.00000000  0.00000000  0.00000000       0.016</span>
    <span class="c">#     0.25000000  0.00000000  0.00000000       0.094</span>
    <span class="c">#     ...</span>

    <span class="c"># Read actual_kpointCartMat_a</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^k-points in units of 2pi/SCALE and weight:&#39;</span> \
      <span class="o">+</span> <span class="s">&#39;( Automatic generation)?$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>    <span class="c"># pats, numMin, numMax</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">kpMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>     <span class="c"># kpoints and weights (multiplicities)</span>
      <span class="mi">4</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="n">numKpoint</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="n">actual_kpointCartMat_a</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">wts</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c"># Sometimes the wts are not normalized to 1, for example in</span>
    <span class="c">#   icsd_633029.cif/non-magnetic/relax_cellshape/1</span>
    <span class="c"># the sum is 1.024</span>
    <span class="n">actual_kpointWeights_a</span> <span class="o">=</span> <span class="n">wts</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">wts</span><span class="p">)</span>


    <span class="c"># Back-calculate the posScaleFactor, method B,</span>
    <span class="c"># using actual_kpointCartMat_a.</span>
    <span class="c"># Method B has narrower ratioDelta values than either</span>
    <span class="c"># method A (above) or method C (below), so we use</span>
    <span class="c"># method B to set resObj.posScaleFactor.</span>
    <span class="c">#</span>
    <span class="c"># We should have:</span>
    <span class="c">#   kpointFracMat = (1. / posScaleFactor) * np.dot(</span>
    <span class="c">#     kpointCartMat, inv( initialRecipBasisMat))</span>
    <span class="c">#</span>
    <span class="c"># So posScaleFactor = median( dotProd / kpointFracMat)</span>

    <span class="c"># cartMat       is numAtom x 3</span>
    <span class="c"># recipBasisMat is 3 x 3</span>
    <span class="c"># dotProd       is numAtom x 3</span>
    <span class="n">dotProd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
      <span class="n">actual_kpointCartMat_a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="p">))</span>

    <span class="c"># maskKp       is numAtom x 3</span>
    <span class="c"># maskDot      is numAtom x 3</span>
    <span class="c"># ratioMat     is numAtom x 3</span>
    <span class="c"># But for one atom, with position [0,0,0],</span>
    <span class="c">#  dotProd == maskDot == maskKp == [--,--,--]</span>

    <span class="n">maskKp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">kpointFracMat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">maskDot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">dotProd</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskKp</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">ratioMat</span> <span class="o">=</span> <span class="n">maskDot</span> <span class="o">/</span> <span class="n">maskKp</span>

    <span class="n">ratioMean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: posScaleFrac ratio method B:&#39;</span>
      <span class="k">print</span> <span class="s">&#39;  B: actual_kpointCartMat_a:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">actual_kpointCartMat_a</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: kpointFracMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointFracMat</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: resObj.initialRecipBasisMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: inv( resObj.initialRecipBasisMat):</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="p">),)</span>
      <span class="k">print</span> <span class="s">&#39;  B: dotProd:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dotProd</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: maskDot:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskDot</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: maskKp:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskKp</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: ratioMat:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMat</span><span class="p">,)</span>

      <span class="k">print</span> <span class="s">&#39;  B: ratioMean:   </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMean</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: ratioMedian: </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMedian</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: ratioMin:    </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMin</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: ratioMax:    </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMax</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  B: ratioDelta:  </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMax</span> <span class="o">-</span> <span class="n">ratioMin</span><span class="p">,)</span>

    <span class="c"># If there is only one atom, at [0,0,0],</span>
    <span class="c"># the median will be masked.  But in this case the</span>
    <span class="c"># posScaleFactor is meaningless, so call it 1.0.</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">ratioMedian</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;MaskedConstant&#39;</span><span class="p">:</span> <span class="n">ratioMedian</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">resObj</span><span class="o">.</span><span class="n">posScaleFactor</span> <span class="o">=</span> <span class="n">ratioMedian</span>


    <span class="c"># Read actual_kpointFracMat_b</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="s">r&#39;^k-points in reciprocal lattice and weights:&#39;</span> \
      <span class="o">+</span> <span class="s">&#39;( Automatic generation)?$&#39;</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">pat</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>    <span class="c"># pats, numMin, numMax</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">kpMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>     <span class="c"># kpoints and weights (multiplicities)</span>
      <span class="mi">4</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="n">numKpoint</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c"># ntok, rowBeg, rowEnd, colBeg, colEnd</span>
    <span class="n">actual_kpointFracMat_b</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">wts</span> <span class="o">=</span> <span class="n">kpMat</span><span class="p">[</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="c"># Sometimes the wts are not normalized to 1, for example in</span>
    <span class="c">#   icsd_633029.cif/non-magnetic/relax_cellshape/1</span>
    <span class="c"># the sum is 1.024</span>
    <span class="n">actual_kpointWeights_b</span> <span class="o">=</span> <span class="n">wts</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">wts</span><span class="p">)</span>


    <span class="c"># Back-calculate the posScaleFactor, method C,</span>
    <span class="c"># using kpointFracMat_b.</span>
    <span class="c"># We use method B, further above, to set resObj.posScaleFactor.</span>
    <span class="c">#</span>
    <span class="c"># We should have:</span>
    <span class="c">#   kpointCartMat == posScaleFactor * np.dot(</span>
    <span class="c">#     kpointFracMat, initialRecipBasisMat)</span>
    <span class="c">#</span>
    <span class="c"># So posScaleFactor = median( kpointCartMat / dotProd)</span>

    <span class="n">dotProd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">actual_kpointFracMat_b</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">initialRecipBasisMat</span><span class="p">)</span>
    <span class="n">maskDotProd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span> <span class="n">dotProd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">maskKpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">kpointCartMat</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskDotProd</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">ratioMat</span> <span class="o">=</span> <span class="n">maskKpoint</span> <span class="o">/</span> <span class="n">maskDotProd</span>
    <span class="n">ratioMean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="n">ratioMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">ratioMat</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: posScaleFrac ratio method C:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMat</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  C: ratioMean:   </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMean</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  C: ratioMedian: </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMedian</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  C: ratioMin:    </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMin</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  C: ratioMax:    </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMax</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;  C: ratioDelta:  </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratioMax</span> <span class="o">-</span> <span class="n">ratioMin</span><span class="p">,)</span>


    <span class="c"># This doesn&#39;t work.  Some sets of weights don&#39;t work this way.</span>
    <span class="c"># For example, lany.projects.ppmdd.pub_data.2013_PRB_GGAUvsHSE/</span>
    <span class="c"># GGAU_defects/Al1N1/Vc_Al/OUTCAR gives</span>
    <span class="c"># uniqWts: [0.015952143569292122, 0.030907278165503486,</span>
    <span class="c">#   0.046859421734795605, 0.093718843469591209, 0.18743768693918242]</span>
    <span class="c"># fac = 1/uniqWts[0] = 62.6875</span>
    <span class="c"># uniqWts * fac are not integers</span>
    <span class="c">#</span>
    <span class="c">## Find kpoint multiplicities by multiplying kpointWeights</span>
    <span class="c">## by the min value that makes them all integers</span>
    <span class="c">#wts = actual_kpointWeights_a</span>
    <span class="c">#uniqWts = list( set( wts))</span>
    <span class="c">#uniqWts.sort()</span>
    <span class="c">#minWt = uniqWts[0]</span>
    <span class="c">#if self.bugLev &gt;= 5:</span>
    <span class="c">#  print &#39;getKpointMat: wts: %s&#39; % (wts,)</span>
    <span class="c">#  print &#39;getKpointMat: uniqWts: %s&#39; % (uniqWts,)</span>
    <span class="c">#  print &#39;getKpointMat: minWt: %s&#39; % (minWt,)</span>
    <span class="c">#factor = None</span>
    <span class="c">#for ii in range(1, 10):</span>
    <span class="c">#  tfact = ii / float( minWt)</span>
    <span class="c">#  allOk = True</span>
    <span class="c">#  for wt in uniqWts:</span>
    <span class="c">#    val = tfact * wt</span>
    <span class="c">#    if abs( val - round(val)) &gt; 1.e-5:</span>
    <span class="c">#      allOk = False</span>
    <span class="c">#      break</span>
    <span class="c">#  if allOk:</span>
    <span class="c">#    factor = tfact</span>
    <span class="c">#    break</span>
    <span class="c">#if factor == None: self.throwerr(&#39;no kpointMults found&#39;, None)</span>
    <span class="c">#actual_kpointMults_a = wts * factor</span>
    <span class="c">#self.checkClose( resObj.kpointMults, actual_kpointMults_a, 1.e-3)</span>


    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: numKpoint: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numKpoint</span><span class="p">,)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: kpointMults sum:  </span><span class="si">%g</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointMults</span><span class="o">.</span><span class="n">sum</span><span class="p">(),)</span>
      <span class="k">print</span> <span class="s">&#39;getKpointMat: kpointWeights sum:  </span><span class="si">%g</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">kpointWeights</span><span class="o">.</span><span class="n">sum</span><span class="p">(),)</span>

<span class="c">#====================================================================</span>

  <span class="c"># eigenMat, occupMat</span>
  <span class="c">#</span>
  <span class="c">#   spin component 1          # this line is not in non-mag calcs</span>
  <span class="c">#</span>
  <span class="c">#   k-point   1 :       0.0000    0.0000    0.0000</span>
  <span class="c">#    band No.  band energies     occupation</span>
  <span class="c">#        1     -14.2072      1.00000</span>
  <span class="c">#        2       2.5938      1.00000</span>
  <span class="c">#       ...</span>
  <span class="c">#       13      23.5652      0.00000</span>
  <span class="c">#</span>
  <span class="c">#   k-point   2 :       0.1250    0.0000    0.0000</span>
  <span class="c">#    band No.  band energies     occupation</span>
  <span class="c">#        1     -14.0551      1.00000</span>
  <span class="c">#        2       1.3327      1.00000</span>
  <span class="c">#       ...</span>
  <span class="c">#       13      23.5652      0.00000</span>
  <span class="c">#   ...</span>
  <span class="c">#   k-point 260 :       0.5000    0.5000    0.5000</span>
  <span class="c">#    band No.  band energies     occupation</span>
  <span class="c">#        1     -13.0330      1.00000</span>
  <span class="c">#        2      -2.2402      1.00000</span>
  <span class="c">#       ...</span>
  <span class="c">#       13      19.0910      0.00000</span>
  <span class="c">#</span>
  <span class="c">#   spin component 2</span>
  <span class="c">#</span>
  <span class="c">#   k-point   1 :       0.0000    0.0000    0.0000</span>
  <span class="c">#    band No.  band energies     occupation</span>
  <span class="c">#        1     -13.6767      1.00000</span>
  <span class="c">#        2       3.2576      1.00000</span>
  <span class="c">#   ...</span>
</div>
<div class="viewcode-block" id="ScanOutcar.getEigenMat"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.getEigenMat">[docs]</a>  <span class="k">def</span> <span class="nf">getEigenMat</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts eigenvalues and occupancies from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">numSpin</span> <span class="o">=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numSpin</span>
    <span class="n">numKpoint</span> <span class="o">=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numKpoint</span>
    <span class="n">numBand</span> <span class="o">=</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numBand</span>

    <span class="n">compPat</span>    <span class="o">=</span> <span class="s">&#39;^spin component [12]$&#39;</span>
    <span class="n">kpFirstPat</span> <span class="o">=</span> <span class="s">&#39;^k-point +1 *: +[-.E0-9]+ +[-.E0-9]+ +[-.E0-9]+$&#39;</span>

    <span class="n">eigenMat</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># Wait until we know numEigen to allocate</span>
    <span class="n">occupMat</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># Wait until we know numEigen to allocate</span>

    <span class="c"># 2014-06-17:In some GW runs, there are no &#39;spin component&#39; lines.</span>
    <span class="c">## Do we have &#39;spin component&#39; lines?</span>
    <span class="c">#compIxs = self.findLines( [compPat], 0, 0)     # pats, numMin, numMax</span>
    <span class="c">#if len(compIxs) == 0:         # if no spin components, or gw calc ...</span>
    <span class="c">#  # if numSpin != 1: self.throwerr(&#39;numSpin mismatch&#39;, None)</span>
    <span class="c">#else:                         # else we have spin components ...</span>
    <span class="c">#  if numSpin != 2: self.throwerr(&#39;numSpin mismatch&#39;, None)</span>

    <span class="c"># Usually DFT OUTCAR files have smallBandPat.</span>
    <span class="c"># Usually GW OUTCAR files have bigBandPat.</span>
    <span class="c"># But there are exceptions where GW files use smallBandPat.</span>

    <span class="n">smallBandPat</span> <span class="o">=</span> <span class="s">&#39;^band No. +band energies +occupation$&#39;</span>
    <span class="n">bigBandPat</span> <span class="o">=</span> <span class="s">&#39;^band No. +\w+-energies +QP-energies +sigma\(\w+\) +V_xc\(\w+\) +V\^pw_x\(r,r</span><span class="se">\&#39;</span><span class="s">\) +Z +occupation$&#39;</span>

    <span class="n">smallBandIxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">kpFirstPat</span><span class="p">,</span> <span class="n">smallBandPat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">bigBandIxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">kpFirstPat</span><span class="p">,</span> <span class="n">bigBandPat</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">smallBandIxs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">bigBandIxs</span><span class="p">):</span>
      <span class="c"># Probably DFT</span>
      <span class="n">firstIxs</span> <span class="o">=</span> <span class="n">smallBandIxs</span>
      <span class="n">eigCol</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">occCol</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">ntok</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="n">hdrDelta</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># Probably GW</span>
      <span class="n">firstIxs</span> <span class="o">=</span> <span class="n">bigBandIxs</span>
      <span class="n">eigCol</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">occCol</span> <span class="o">=</span> <span class="mi">7</span>
      <span class="n">ntok</span> <span class="o">=</span> <span class="mi">8</span>
      <span class="n">hdrDelta</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstIxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">numBand</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">eigenMat</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">occupMat</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">numSpin</span><span class="p">):</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="n">firstIxs</span><span class="p">[</span> <span class="o">-</span><span class="n">numSpin</span> <span class="o">+</span> <span class="n">isp</span><span class="p">]</span>    <span class="c"># use the last</span>
        <span class="n">isection</span> <span class="o">=</span> <span class="n">istart</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">hdrDelta</span>
        <span class="k">for</span> <span class="n">ikp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">numKpoint</span><span class="p">):</span>
          <span class="c"># Parse one k-point section, for numBand lines</span>
          <span class="n">tmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
            <span class="n">ntok</span><span class="p">,</span>            <span class="c"># num tokens on each line</span>
            <span class="n">isection</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="c"># rBeg, rEnd==0: go to blank line</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">ntok</span><span class="p">)</span>         <span class="c"># cBeg, cEnd</span>
          <span class="n">numEigen</span> <span class="o">=</span> <span class="n">tmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">isection</span> <span class="o">+=</span> <span class="n">numEigen</span> <span class="o">+</span> <span class="n">hdrDelta</span>
          <span class="k">if</span> <span class="n">eigenMat</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Finally allocate matrices</span>
            <span class="n">eigenMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span> <span class="n">numSpin</span><span class="p">,</span> <span class="n">numKpoint</span><span class="p">,</span> <span class="n">numEigen</span><span class="p">])</span>
            <span class="n">occupMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span> <span class="n">numSpin</span><span class="p">,</span> <span class="n">numKpoint</span><span class="p">,</span> <span class="n">numEigen</span><span class="p">])</span>
          <span class="n">eigenMat</span><span class="p">[</span> <span class="n">isp</span><span class="p">,</span> <span class="n">ikp</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">numEigen</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmat</span><span class="p">[</span> <span class="mi">0</span><span class="p">:</span><span class="n">numEigen</span><span class="p">,</span> <span class="n">eigCol</span><span class="p">]</span> <span class="c"># eig col</span>
          <span class="n">occupMat</span><span class="p">[</span> <span class="n">isp</span><span class="p">,</span> <span class="n">ikp</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">numEigen</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmat</span><span class="p">[</span> <span class="mi">0</span><span class="p">:</span><span class="n">numEigen</span><span class="p">,</span> <span class="n">occCol</span><span class="p">]</span> <span class="c"># occ col</span>

      <span class="n">resObj</span><span class="o">.</span><span class="n">eigenMat</span> <span class="o">=</span> <span class="n">eigenMat</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">occupMat</span> <span class="o">=</span> <span class="n">occupMat</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numSpin</span><span class="p">):</span>
          <span class="k">print</span> <span class="s">&#39;getEigenMat: isp: </span><span class="si">%d</span><span class="s">  eigenMat:  shape: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">eigenMat</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">eigenMat</span><span class="p">[</span><span class="n">isp</span><span class="p">],)</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">resObj</span><span class="o">.</span><span class="n">numSpin</span><span class="p">):</span>
          <span class="k">print</span> <span class="s">&#39;getEigenMat: isp: </span><span class="si">%d</span><span class="s">  occupMat:  shape: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">occupMat</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">resObj</span><span class="o">.</span><span class="n">occupMat</span><span class="p">[</span><span class="n">isp</span><span class="p">],)</span>

<span class="c">#====================================================================</span>

<span class="c"># Get the line:</span>
<span class="c">#   number of dos      NEDOS =   5001   number of ions     NIONS =      2</span>
<span class="c">#</span>
<span class="c"># The imag part is the nedos lines following</span>
<span class="c">#</span>
<span class="c">#  frequency dependent IMAGINARY DIELECTRIC FUNCTION (independent particle, no local field effects)</span>
<span class="c">#     E(ev)      X         Y         Z        XY        YZ        ZX</span>
<span class="c">#  ----------------------------------------------------------------------</span>
<span class="c">#     0.000000    6.024874    6.024874    6.024874   -0.000000   -0.000000   -0.000000</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># The real part is the nedos lines following</span>
<span class="c">#</span>
<span class="c">#  frequency dependent      REAL DIELECTRIC FUNCTION (independent particle, no local field effects)</span>
<span class="c">#     E(ev)      X         Y         Z        XY        YZ        ZX</span>
<span class="c">#  ----------------------------------------------------------------------</span>
<span class="c">#     0.000000    6.024874    6.024874    6.024874   -0.000000   -0.000000   -0.000000</span>
</div>
  <span class="k">def</span> <span class="nf">getDielectric</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">resObj</span><span class="p">):</span>         <span class="c"># resulting object to be filled</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extracts the dielectric function from OUTCAR, setting resObj attributes.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">patImag</span> <span class="o">=</span> <span class="s">&#39;^ *frequency dependent *IMAGINARY DIELECTRIC FUNCTION&#39;</span>
    <span class="n">patReal</span> <span class="o">=</span> <span class="s">&#39;^ *frequency dependent *REAL DIELECTRIC FUNCTION&#39;</span>

    <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">patImag</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>          <span class="c"># numMin, numMax</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">dielectricImag</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">dielectricReal</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;getDielectric: all None&#39;</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">irow</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">dielectricImag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
        <span class="mi">7</span><span class="p">,</span>           <span class="c"># num tokens on each line</span>
        <span class="n">irow</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="c"># rBeg, rEnd==0: go to blank line</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>        <span class="c"># cBeg, cEnd</span>

      <span class="n">ixs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLines</span><span class="p">(</span> <span class="p">[</span><span class="n">patReal</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>          <span class="c"># numMin, numMax</span>
      <span class="n">irow</span> <span class="o">=</span> <span class="n">ixs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span>
      <span class="n">resObj</span><span class="o">.</span><span class="n">dielectricReal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseMatrix</span><span class="p">(</span>
        <span class="mi">7</span><span class="p">,</span>           <span class="c"># num tokens on each line</span>
        <span class="n">irow</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="c"># rBeg, rEnd==0: go to blank line</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>        <span class="c"># cBeg, cEnd</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bugLev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;getDielectric: dielectricImag.shape: </span><span class="si">%s</span><span class="s">&#39;</span> \
          <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">dielectricImag</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>
        <span class="k">print</span> <span class="s">&#39;getDielectric: dielectricReal.shape: </span><span class="si">%s</span><span class="s">&#39;</span> \
          <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">dielectricReal</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>
        <span class="k">print</span> <span class="s">&#39;getDielectric: dielectricImag:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">dielectricImag</span><span class="p">,)</span>
        <span class="k">print</span> <span class="s">&#39;getDielectric: dielectricReal:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resObj</span><span class="o">.</span><span class="n">dielectricReal</span><span class="p">,)</span>

<span class="c">#====================================================================</span>

  <span class="c"># Returns a list of line numbers ixs such that at each ix,</span>
  <span class="c"># lines[ix+i] matches pats[i].</span>

<div class="viewcode-block" id="ScanOutcar.findLines"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.findLines">[docs]</a>  <span class="k">def</span> <span class="nf">findLines</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>         <span class="c"># self</span>
    <span class="n">pats</span><span class="p">,</span>         <span class="c"># list of patterns to be matched by consecutive lines</span>
    <span class="n">numMin</span><span class="p">,</span>       <span class="c"># min num entire matches; else error</span>
    <span class="n">numMax</span><span class="p">):</span>      <span class="c"># max num entire matches or 0; else error</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Finds a list of line numbers in OUTCAR matching pats.</span>
<span class="sd">    Each line num is the start of a group of lines</span>
<span class="sd">    that consecutively match the patterns in pats.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># Insure all pats are &#39;^...$&#39;</span>
    <span class="n">regexs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">pats</span><span class="p">:</span>
      <span class="n">regexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="n">pat</span><span class="p">))</span>

    <span class="n">resIxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">numLine</span><span class="p">):</span>
      <span class="c"># Do the pats match starting at iline ...</span>
      <span class="n">allOk</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">pats</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">iline</span> <span class="o">+</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">iline</span> <span class="o">+</span> <span class="n">ii</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numLine</span><span class="p">:</span>
          <span class="n">allOk</span> <span class="o">=</span> <span class="bp">False</span>
          <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regexs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="o">+</span><span class="n">ii</span><span class="p">]):</span>
          <span class="n">allOk</span> <span class="o">=</span> <span class="bp">False</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="n">allOk</span><span class="p">:</span> <span class="n">resIxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">iline</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resIxs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numMin</span> \
      <span class="ow">or</span> <span class="p">(</span><span class="n">numMax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resIxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">numMax</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">((</span><span class="s">&#39;num found mismatch.  numMin: </span><span class="si">%d</span><span class="s">  numMax: </span><span class="si">%d</span><span class="s">&#39;</span>
        <span class="o">+</span> <span class="s">&#39;  numFound: </span><span class="si">%d</span><span class="s">  pats: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">numMin</span><span class="p">,</span> <span class="n">numMax</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">resIxs</span><span class="p">),</span> <span class="n">pats</span><span class="p">,),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resIxs</span>

<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="ScanOutcar.parseMatrix"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.parseMatrix">[docs]</a>  <span class="k">def</span> <span class="nf">parseMatrix</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>            <span class="c"># self</span>
    <span class="n">ntok</span><span class="p">,</span>            <span class="c"># number of tokens per line</span>
    <span class="n">begLine</span><span class="p">,</span>         <span class="c"># start line index</span>
    <span class="n">endLine</span><span class="p">,</span>         <span class="c"># 1 + last line index</span>
    <span class="n">begCol</span><span class="p">,</span>          <span class="c"># first column index, typically 0</span>
    <span class="n">endCol</span><span class="p">):</span>         <span class="c"># 1 + last column index, typically ntok</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parses an array line::</span>

<span class="sd">        0.0004124  2.1551750  2.1553184    -0.2320833  0.2320088  0.2320195</span>
<span class="sd">        2.1551376  0.0004322  2.1552987     0.2320129 -0.2320836  0.2320237</span>
<span class="sd">        2.1548955  2.1549131  0.0006743     0.2320650  0.2320652 -0.2320942</span>

<span class="sd">    Returns an np.ndarray.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iline</span> <span class="o">=</span> <span class="n">begLine</span>
    <span class="k">while</span> <span class="n">endLine</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">iline</span> <span class="o">&lt;</span> <span class="n">endLine</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="s">&#39;^-----+$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">endLine</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;unexpected empty line&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)</span>
        <span class="k">break</span>

      <span class="c"># Kluge:</span>
      <span class="c"># Fix run-together lines like: ... -2.252011135-14.597316840 ...</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\d-&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mat</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c"># index of &#39;-&#39;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">ix</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">ix</span><span class="p">:]</span>

      <span class="n">toks</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ntok</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span>
          <span class="s">&#39;bad ntok.  Expected: </span><span class="si">%d</span><span class="s">  found: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ntok</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">,)),</span> <span class="n">iline</span><span class="p">)</span>
      <span class="n">vals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">float</span><span class="p">,</span> <span class="n">toks</span><span class="p">[</span><span class="n">begCol</span><span class="p">:</span><span class="n">endCol</span><span class="p">])</span>
      <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">vals</span><span class="p">)</span>
      <span class="n">iline</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="s">&#39;^-----+$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;bad endLine&#39;</span><span class="p">,</span> <span class="n">endLine</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="ScanOutcar.formatMatrix"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.formatMatrix">[docs]</a>  <span class="k">def</span> <span class="nf">formatMatrix</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>         <span class="c"># self</span>
    <span class="n">vmat</span><span class="p">):</span>        <span class="c"># 2-dim matrix of floats to format</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Formats a matrix for printing.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">vmat</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;(Matrix is None)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">shp</span> <span class="o">=</span> <span class="n">vmat</span><span class="o">.</span><span class="n">shape</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">shp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;bad shape&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;  row </span><span class="si">%3d</span><span class="s">: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ii</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">shp</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
          <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;  </span><span class="si">%7.3f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vmat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">],)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">return</span> <span class="n">msg</span>

<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="ScanOutcar.formatMatrixPython"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.formatMatrixPython">[docs]</a>  <span class="k">def</span> <span class="nf">formatMatrixPython</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>         <span class="c"># self</span>
    <span class="n">vmat</span><span class="p">):</span>        <span class="c"># 2-dim matrix of floats to format</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Formats a matrix in Python input format.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">vmat</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;(Matrix is None)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">shp</span> <span class="o">=</span> <span class="n">vmat</span><span class="o">.</span><span class="n">shape</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">shp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;bad shape&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;[</span><span class="se">\n</span><span class="s">&#39;</span>
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;  [&#39;</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">shp</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
          <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39; </span><span class="si">%9.5f</span><span class="s">,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vmat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">],)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39; ],</span><span class="se">\n</span><span class="s">&#39;</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;]</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">return</span> <span class="n">msg</span>

<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="ScanOutcar.checkClose"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.checkClose">[docs]</a>  <span class="k">def</span> <span class="nf">checkClose</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>          <span class="c"># self</span>
    <span class="n">mata</span><span class="p">,</span>          <span class="c"># matrix A</span>
    <span class="n">matb</span><span class="p">,</span>          <span class="c"># matrix B</span>
    <span class="n">absErr</span><span class="p">):</span>       <span class="c"># max absolute error</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks that two matrices have the same shape and are close in value.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">mata</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">matb</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;mata or matb is None&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mata</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">matb</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span><span class="s">&#39;checkClose: shape mismatch: mata: </span><span class="si">%s</span><span class="s">  matb: </span><span class="si">%s</span><span class="s">&#39;</span> \
        <span class="o">%</span> <span class="p">(</span><span class="n">mata</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">matb</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">mata</span> <span class="o">-</span> <span class="n">matb</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">absErr</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;checkClose: mismatch.</span><span class="se">\n</span><span class="s">&#39;</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;mata:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mata</span><span class="p">,)</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;matb:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">matb</span><span class="p">,)</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;delta = matb - mata:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">matb</span> <span class="o">-</span> <span class="n">mata</span><span class="p">,)</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;max abs delta: </span><span class="si">%g</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">matb</span> <span class="o">-</span> <span class="n">mata</span><span class="p">)))</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">checkClose: mismatch.  See above.&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">throwerr</span><span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<span class="c">#====================================================================</span>
</div>
<div class="viewcode-block" id="ScanOutcar.throwerr"><a class="viewcode-back" href="../../nrelmatdb/ScanOutcar.html#nrelmat.ScanOutcar.ScanOutcar.throwerr">[docs]</a>  <span class="k">def</span> <span class="nf">throwerr</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>       <span class="c"># self</span>
    <span class="n">msg</span><span class="p">,</span>        <span class="c"># error message</span>
    <span class="n">ix</span><span class="p">):</span>        <span class="c"># current line index (origin 0) in OUTCAR</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Raises an Exception</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fullMsg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>
    <span class="n">fullMsg</span> <span class="o">+=</span> <span class="s">&#39;  inDir: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inDir</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">ix</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">fullMsg</span> <span class="o">+=</span> <span class="s">&#39;  ix: </span><span class="si">%d</span><span class="se">\n</span><span class="s">  line: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">ix</span><span class="p">],)</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="n">fullMsg</span><span class="p">)</span>

<span class="c">#====================================================================</span>

<span class="c"># end of class ScanOutcar</span>

<span class="c">#====================================================================</span>
</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span> <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pylada 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Mayeul d&#39;Avezac.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>